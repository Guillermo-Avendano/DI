version: "3.0"

services: 
  datainit:
      image: busybox:latest
      command: sh -c "chown -R 3003:0 /home/rocket/rochade/conf && chown -R 3003:0 /home/rocket/rochade/appl && chown -R 3003:0 /home/rocket/rochade/datbas && chown -R 3003:0 /home/rocket/Index_Update_Service/conf && chown -R 3003:0 /home/rocket/Index_Update_Service/logs && chown -R 3003:0 /home/rocket/conf && chown -R 3003:0 /home/rocket/tomcat/logs"
      volumes:
      - ./conf:/home/rocket/rochade/conf
      - ./appl:/home/rocket/rochade/appl
      - ./datbas:/home/rocket/rochade/datbas
      - ./idxupd_conf:/home/rocket/Index_Update_Service/conf
      - ./idxupd_logs:/home/rocket/Index_Update_Service/logs
      - ./tomcat_conf:/home/rocket/conf
      - ./tomcat_logs:/home/rocket/tomcat/logs
  di-workflow:
    image: postgres:14-alpine
    container_name: di-workflow
    hostname: di-workflow
    ports:
    - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - "db-data:/var/lib/postgresql/data"
      - ./create_workflow_db.sh:/docker-entrypoint-initdb.d/create_workflow_db.sh
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 10s
      timeout: 5s
      retries: 5
  di-server:
    image: 'guillermoavendano/di-server:10.00.002'
    container_name: di-server
    hostname: di-server
    environment:
      DI_SERVER_LICENSE_NUMBER: "0374417A-D6E22E0A/06220208-2010D1E4/01D0C41D-D0C429D0/C421D0C4-2DD0C43D/D8C4C108-C0280800/04081814-1D250C01"
      DI_SERVER_LICENSE_COMPANY: "ASG Internal Use"
    ports:
      - '8888:8888'
    volumes:
    - ./datbas:/home/rocket/rochade/datbas
    - ./conf:/home/rocket/rochade/conf
    - ./appl:/home/rocket/rochade/appl
    depends_on:
      - datainit
  di-solr:
    image: solr:8.11.1
    container_name: di-solr
    hostname: di-solr
    ports:
     - "8983:8983"
    volumes:
      - solr_data:/var/solr
  di-indexupd:
    image: 'guillermoavendano/di-indexupd:10.00.002'
    container_name: di-indexupd
    command: sh -c "sleep 9999999"
    environment:
       DI_SOLR_HOST: "di-solr"
       DI_SOLR_PORT: "8983"
       DI_SERVER_HOST: "di-server"
       DI_SERVER_PORT: 8888
       DI_SERVER_USER: "ADMIN"
       DI_SERVER_PASS: "rochade"
    volumes:
    - ./idxupd_conf:/home/rocket/Index_Update_Service/conf
    - ./idxupd_logs:/home/rocket/Index_Update_Service/logs
    depends_on:
      - datainit
  di-webapp:
    image: 'guillermoavendano/di-webapp:10.00.002'
    container_name: di-webapp
    hostname: di-webapp
    command: sh -c "sleep 9999999"
    ports:
      - 8080:8080
    environment:
       DI_SOLR_HOST: "di-solr"
       DI_SOLR_PORT: "8983"
       DI_SERVER_HOST: "di-server"
       DI_SERVER_PORT: 8888
       DI_SERVER_USER: "ADMIN"
       DI_SERVER_PASS: "rochade"
       DI_POSTGRES_HOST: "di-workflow"
       DI_POSTGRES_PORT: 5432
       DI_POSTGRES_USER: postgres
       DI_POSTGRES_PASS: postgres
    volumes:
    - ./tomcat_conf:/home/rocket/conf
    - ./tomcat_logs:/home/rocket/tomcat/logs
    depends_on:
      - datainit
      
volumes:
  solr_data:
  db-data: